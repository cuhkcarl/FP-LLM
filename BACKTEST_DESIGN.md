# FPL策略回测设计规范

## 🎯 项目目标

构建完整的回测框架，对FPL（Fantasy Premier League）策略进行历史数据验证和对比分析，实现基于证据的策略优化。

## 📋 策略定义

### S0: 静态基准策略
- **概念**: "群体智慧"基准，使用最受欢迎的15人组合
- **方法**: 使用基于赛季开始时拥有率的预计算最优阵容
- **约束**: £100m预算，2GK/5DEF/5MID/3FWD，每队最多3人
- **操作**: 无转会，无芯片 - 仅优化每轮首发11人和队长选择
- **目的**: 提供稳定基准，衡量主动管理的价值

### S1: 纯转会策略
- **概念**: 无芯片复杂性的纯转会优化
- **方法**: 使用现有`best_transfers()`函数在全部球员池(~600人)中优化
- **约束**: FPL转会规则，击中成本(-4分)，预算限制
- **操作**: 仅转会优化，无芯片
- **目的**: 独立测量转会决策的价值

### S2: 完整策略
- **概念**: 利用所有FPL机制的完整优化工具包
- **方法**: 在全部球员池中进行协调的转会+芯片优化
- **约束**: 所有FPL规则和约束
- **操作**: 转会优化 + 芯片策略(BB/TC/FH/WC)
- **目的**: 测试完整复杂性是否能证明计算成本合理

## 📊 基准对比(Benchmarks)

### B1: 官方FPL统计基准
- **概念**: 基于FPL官方数据的平均表现基准
- **数据源**: 官方平均分、最高分、最多队长选择
- **方法**: 使用正态分布估算和历史数据调整
- **目的**: 提供真实的玩家群体表现参考

### B2: 群体智慧基准
- **概念**: 模拟普通玩家的决策模式
- **方法**: 跟随最受欢迎球员选择和队长决策
- **转会规则**: 当拥有率变化>10%时触发转会
- **芯片使用**: 模拟30%玩家的芯片使用率
- **目的**: 对比主动策略vs被动跟随的效果

### B3: Top 10k估算基准
- **概念**: 估算顶级玩家(前1万名)的表现水平
- **方法**: 基于99.1百分位数的正态近似
- **调整**: 历史数据校准和分布修正
- **目的**: 衡量策略是否达到精英玩家水平

### B4: 百分位分布基准
- **概念**: 基于抽样的完整表现分布
- **方法**: 从FPL API抽样1000名玩家
- **输出**: 多个百分位点(10th, 25th, 50th, 75th, 90th, 95th)
- **目的**: 提供策略在整体分布中的精确定位

## 🏗️ 架构要求

### 核心组件

1. **时间控制器**
   - 确保回测期间严格的时间一致性
   - 防止未来信息泄露
   - 管理每个GW的历史数据快照

2. **策略接口**
   - 所有策略的标准化API
   - 一致的输入/输出格式
   - 错误处理和回退机制

3. **并行执行引擎**
   - 多核策略执行
   - 进度监控和资源管理
   - 强健的错误恢复

4. **历史数据管理器**
   - 赛季数据加载和缓存
   - 数据验证和清理
   - 高效的数据访问模式

### 目录结构
```
src/backtest/
├── engine/           # 核心回测执行
├── strategies/       # 策略实现
├── data/            # 历史数据管理
└── analysis/        # 结果分析工具

scripts/backtest/     # 命令行工具
configs/backtest/     # 配置模板
data/backtest/       # 历史数据存储
results/backtest/    # 输出结果
```

## 📊 数据要求

### 历史数据源
- FPL API历史数据(vaastav/fpl仓库)
- 球员统计、赛程、拥有率数据
- 实际比赛周得分用于验证

### 数据格式
- Parquet文件用于高效存储和访问
- 跨赛季一致的数据架构
- 按GW的时间数据组织

### 数据验证
- 所有必需赛季的完整性检查
- 数据完整性验证
- 缺失数据处理策略

## ⚡ 性能目标

### 执行时间目标（待评估）
- **S0**:
- **S1**:
- **S2**:

### 可扩展性要求
- 支持6+历史赛季(2019-20至2024-25)
- 并行策略执行
- 内存高效的数据处理
- 进度监控和取消支持

## 🔧 配置系统

### 灵活配置
- 基于YAML的配置文件
- 策略特定参数覆盖
- 环境特定设置
- 验证和架构检查

### 关键配置区域
- 赛季选择和数据路径
- 策略启用/禁用标志
- 并行执行参数
- 输出格式和目标

## 📈 输出和分析

### 报告生成
- 人类可读的markdown摘要
- 结构化JSON数据用于进一步分析
- 性能指标和比较
- 可视化就绪的数据导出

### 关键指标
- 每个策略每个赛季的总分
- 转会效率和击中分析
- 芯片使用效果
- 多赛季的一致性

## 🎯 成功标准

1. **可重现性**: 相同配置产生相同结果
2. **时间完整性**: 无未来信息泄露
3. **性能**: 实用的合理执行时间
4. **准确性**: 结果与手动策略执行一致
5. **可扩展性**: 易于添加新策略和分析

## 🚀 实施优先级

### 阶段1: 基础
1. 时间控制器和数据管理
2. 基本策略接口
3. 简单执行引擎

### 阶段2: 策略实施
1. S0静态基准与预计算阵容
2. S1转会优化集成
3. S2完整策略与芯片逻辑

### 阶段3: 高级功能
1. 并行执行和性能优化
2. 综合分析和报告
3. 多赛季分析和可视化

## 📝 参考数据

### S0最优阵容(2023-24)
群体智慧基准使用这个预计算的最优阵容:
- **总价值**: £99.5m
- **球员**: 见`configs/backtest/s0_optimal_squad.yaml`
- **优化方法**: 最大化总拥有率百分比
- **约束**: 满足所有FPL规则

此阵容在所有回测场景中作为S0策略的固定基准。
